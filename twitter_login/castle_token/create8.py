from .utils import n_digit_hex


def float_encode(exp_bits, mant_bits, x):
    if x == 0:
        return 0
    e = 0
    x = abs(x)
    while x >= 2:
        x /= 2
        e += 1
    while x < 1:
        x *= 2
        e -= 1

    e = min(e, (1 << exp_bits) - 1)
    m = 0
    x -= 1
    for _ in range(mant_bits):
        x *= 2
        bit = int(x)
        m = (m << 1) | bit
        x -= bit

    return (e << mant_bits) | m


def encode_mini_float_byte(value):
    if value is None:
        return 0
    value = max(value, 0)
    if value > 15:
        v = min(value, 65536) - 14
        return float_encode(4, 3, v) | 0x80
    else:
        return float_encode(2, 4, value + 1) | 0x40


def encode_array_to_hex(arr):
    return ''.join(map(lambda x: n_digit_hex(encode_mini_float_byte(x), 2), arr))


def arr_to_16bits(arr):
    bits = list(map(lambda x: int(bool(x)), arr[:16]))
    if len(bits) < 16:
        bits += [0] * (16 - len(bits))

    value = 0
    for bit in bits:
        value = (value << 1) | bit

    return value


def build_arr1_header(arr1):
    return 6 << 20 | 2 << 16 | (arr_to_16bits(arr1) & 65535)


def int_to_fixed_hex(n):
    max_value = (1 << (8 * 3)) - 1
    n = min(max_value, n)
    return n.to_bytes(3, byteorder='big').hex()


def arr_to_hex_2dig(arr):
    return ''.join(map(lambda x: n_digit_hex(x, 2), arr))


def encode_3_arrs(arr1, arr2, arr3):
    return int_to_fixed_hex(build_arr1_header(arr1)) + encode_array_to_hex(arr2) + arr_to_hex_2dig(arr3) + n_digit_hex(len(arr3), 2)
# print(arr_to_hex_2dig([1,2,3,4,5]))


# x = [[87, 192, 149, 144, 221, 28, 111, 21, 94, 81, 252, 24, 68, 97, 161, 247, 16, 31, 90, 144, 92, 233, 193, 225, 41, 239, 125, 165, 232, 63, 223, 122, 35, 237, 241, 223, 66, 111, 102, 53, 164, 168, 111, 240, 132, 226, 142, 102, 74, 205, 111, 70, 211, 254, 165, 107, 22, 57, 65, 108, 94, 35, 186, 250, 157, 26, 154, 169, 15, 27, 254, 192, 156, 201, 221, 63, 28, 215, 239, 231, 120, 22, 183, 44, 117, 63, 227, 215, 195, 157, 256, 244, 178, 31, 189, 85, 87, 85, 231, 34, 79, 135, 173, 54, 18, 229, 208, 16, 61, 31, 213, 138, 194, 147, 70, 88, 168, 221, 137, 183, 116, 30, 256, 91, 237, 24, 227, 210, 121, 231, 175, 101, 117, 70, 200, 160, 172, 135, 154, 92, 175, 9, 48, 160, 51, 121, 15, 231, 21, 63, 88, 167, 97, 247, 100, 12, 121, 244, 153, 240, 213, 67, 58, 103, 63, 5, 89, 4, 26, 78, 244, 126, 144, 4, 223, 244, 42, 223, 159, 61, 87, 5, 236, 7, 246, 227, 75, 149, 47, 52, 149, 28, 188, 46, 45, 110, 181, 144, 75, 203, 139, 214, 231, 179, 167, 3, 175, 253, 146, 177, 228, 254, 61, 81, 35, 2, 227, 199, 189, 80, 34, 203, 75, 11, 109, 118, 73, 116, 176, 135, 227, 178, 76, 251, 209, 224, 122, 51, 138, 109, 25, 223, 83, 140, 117, 75, 113], [54, 146, 229, 28, 38, 198, 118, 195, 184, 189, 85, 102, 101, 3, 169, 233, 168, 63, 147, 59, 71, 52, 22, 188, 174, 149, 216, 77, 18, 179, 190, 69, 95, 70, 134, 176, 23, 149, 131, 201, 228, 150, 108, 52, 22, 129, 115, 253, 72, 208, 6, 85, 36, 20, 244, 27, 46, 162, 210, 63, 238, 28, 40, 25, 196, 165, 151, 107, 149, 14, 199, 208, 174, 71, 54, 118, 131, 221, 116, 213, 81, 183, 181, 168, 205, 138, 61, 148, 42, 15, 65, 207, 150, 49, 253, 15, 240, 108, 67, 102, 136, 12, 198, 110, 200, 151, 29, 28, 108, 5, 124, 18, 30, 21, 243, 4, 186, 224, 78, 145, 186, 244, 120, 245, 108, 218, 192, 187, 203, 19, 58, 191, 167, 197, 117, 170, 112, 240, 222, 247, 222, 70, 105, 66, 17, 78, 62, 200, 199, 204, 167, 140, 217, 226, 233, 83, 161, 75, 61, 140, 194, 222, 158, 165, 185, 125, 14, 246, 247, 166, 202, 241, 32, 10, 89, 7, 59, 206, 156, 45, 120, 17, 109, 88, 10, 77, 94, 200, 158, 5, 138, 194, 132, 254, 166, 137, 228, 39, 255, 214, 126, 125, 203, 227, 76, 1, 65, 215, 225, 244, 113, 233, 15, 74, 25, 222, 126, 185, 101, 212, 82], [120, 28, 168, 167, 4, 211, 12, 193, 253, 188, 166, 108, 204, 135, 255, 125, 79, 109, 103, 109, 1, 102, 243, 221, 213, 199, 114, 128, 49, 48, 141, 46, 66, 254, 216, 45, 152, 204, 38, 176, 149, 9, 43, 239, 201, 148, 106, 34, 130, 89, 188, 233, 232, 42, 206, 12, 229, 121, 248, 46, 84, 192, 203, 116, 191, 247, 167, 221, 82, 117, 36, 221, 201, 10, 31, 93, 186, 196, 228, 71, 234, 124, 129, 88, 8, 164, 227, 148, 83, 106, 133, 101, 175, 188, 33, 213, 247, 195, 116, 17, 38, 38, 211, 172, 39, 64, 51, 26, 32, 62, 256, 84, 221, 100, 169, 80, 248, 226, 202, 13, 14, 176, 104, 111, 224, 55, 195, 224, 34, 66, 13, 218, 67, 90, 125, 96, 254, 72, 212, 82, 18, 252, 45, 244, 39, 181, 238, 7, 44, 21, 206, 201, 221, 88, 87, 166, 156, 154, 211, 256, 136, 140, 153, 186, 140, 45, 236, 25, 154, 73, 254, 212, 70, 221, 14, 62, 109, 181, 58, 251, 224, 3, 129, 158, 185, 246, 28, 93, 21, 206, 89, 244, 88, 48, 161, 148, 238, 90, 170, 166, 6, 159, 71, 125, 185, 217, 43, 176, 97, 87, 100, 129, 208, 167, 111, 88, 174, 98, 57, 136, 28, 5, 18, 39, 181, 130, 13, 7, 172, 100, 74, 135, 44, 96, 4, 130, 212, 47]]
# print(encode_3_arrs(*x) == '62ffffaab8bd9ea4bbb5bbbabab0b3b260b9bdb9acb8abaea998babab8bcaf90babbadb2aeb7ba99b8b6bbbdb8b3a998b6b4beaebc6cb0a394be9da8b9bcacbe9ea59bbbb9b8b3b87ebbbcbaaeaab5b6bcb4bcb0babab9bbb7abb8a670acbcb8a8be70beb3adb3b77abbb4bbb89f9eb368b590a096be64babdb0b8babeb5beb3bcbbbabb92abbbb9bbb4b9b4bebdbebdaeb3ad8cb0acbbbbbbb9b7bcbdbdb0b9afabb7bbbdb9b9bab57ebebeb9bbbea176b170abbcb8a7b58cb3b176afb2bbb968b7bbb6bfb9b7bda4bfbcb6b5bbbdaf50acbcbdbeb4bd70af9bbdb6bab2bcb0781ca8a704d30cc1fdbca66ccc87ff7d4f6d676d0166f3ddd5c7728031308d2e42fed82d98cc26b095092befc9946a228259bce9e82ace0ce579f82e54c0cb74bff7a7dd527524ddc90a1f5dbac4e447ea7c815808a4e394536a8565afbc21d5f7c374112626d3ac2740331a203e0054dd64a950f8e2ca0d0eb0686fe037c3e022420dda435a7d60fe48d45212fc2df427b5ee072c15cec9dd5857a69c9ad300888c99ba8c2dec199a49fed446dd0e3e6db53afbe003819eb9f61c5d15ce59f45830a194ee5aaaa6069f477db9d92bb061576481d0a76f58ae6239881c051227b5820d07ac644a872c600482d42fee')
